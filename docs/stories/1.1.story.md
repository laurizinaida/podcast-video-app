# Story 1.1: é¡¹ç›®åˆå§‹åŒ–ä¸åŸºç¡€ç”¨æˆ·æ³¨å†Œ

## Status
- Approve

## Story
**As a** new user,
**I want** to be able to register for an account using my email and password, and then log in,
**so that** I can access the application and start creating video projects.

## Acceptance Criteria
1.  A user can navigate to a registration page.
2.  On the registration page, a user can enter their name, email, and a password.
3.  The system validates the email format and password strength (at least 8 characters, with uppercase, lowercase, and a number).
4.  Upon successful registration, a new user record is created in the database.
5.  The user is automatically logged in and redirected to their project dashboard after registration.
6.  A user can navigate to a login page.
7.  On the login page, a user can enter their registered email and password to log in.
8.  Upon successful login, the system creates a secure session and redirects the user to their project dashboard.
9.  The system prevents registration with an email address that is already in use.
10. The system shows appropriate error messages for invalid input or failed login attempts.

## Tasks / Subtasks
- [ ] **Task 1: Set up Monorepo Structure (AC: All)**
    - [ ] Initialize a new `pnpm` workspace. [Source: architecture/14-development-workflow.md]
    - [ ] Create the directory structure: `apps/web`, `apps/api`, `packages/shared`, `packages/config`. [Source: architecture/13-unified-project-structure.md]
    - [ ] Configure `turbo.json` for the monorepo pipeline.

- [x] **Task 2: Backend - Database and User Model Setup (AC: 4, 9)**
    - [x] Create the `Users` table in Cloudflare D1 using the defined schema. [Source: architecture/09-database-schema.md]
    - [x] Define the `User` interface in `packages/shared/types/user.ts`. [Source: architecture/04-data-models.md]

- [x] **Task 3: Backend - Implement Registration API Endpoint (AC: 2, 3, 4, 9)**
    - [x] Create the `POST /api/auth/register` API route in `apps/api`. [Source: architecture/05-api-specification.md]
    - [x] Implement input validation for name, email, and password.
    - [x] Implement password hashing using `bcrypt` with a cost factor of 12. [Source: architecture/16-security-and-performance.md]
    - [x] Implement logic to check for existing users and return a 409 conflict error.
    - [x] Implement logic to insert the new user into the D1 `Users` table. [Source: architecture/10-data-and-storage-access-patterns.md]

- [x] **Task 4: Backend - Implement Authentication and Session Management (AC: 7, 8)** *(éƒ¨åˆ†å®Œæˆ)*
    - [ ] Configure `Auth.js (NextAuth)` for the project. [Source: architecture/03-tech-stack.md]
    - [x] Implement the `POST /api/auth/login` (credentials) endpoint. [Source: architecture/05-api-specification.md]
    - [ ] Implement the `POST /api/auth/logout` endpoint.
    - [ ] Implement the `GET /api/auth/me` endpoint to retrieve session user data.
    - [ ] Configure secure, HttpOnly session cookies. [Source: architecture/11-frontend-architecture.md#11.1.4]

- [ ] **Task 5: Frontend - Create UI Components (AC: 1, 2, 6, 7)**
    - [ ] Create a reusable `Input` component using Headless UI and Tailwind CSS. [Source: architecture/03-tech-stack.md]
    - [ ] Create a reusable `Button` component.
    - [ ] Create the `RegisterForm` component in `apps/web`.
    - [ ] Create the `LoginForm` component in `apps/web`.

- [ ] **Task 6: Frontend - Create Pages and State Management (AC: 1, 5, 6, 8, 10)**
    - [ ] Create the `/register` page (`apps/web/app/register/page.tsx`).
    - [ ] Create the `/login` page (`apps/web/app/login/page.tsx`).
    - [ ] Create the `/dashboard` page (`apps/web/app/dashboard/page.tsx`).
    - [ ] Implement the `useAuthStore` with Zustand for global auth state. [Source: architecture/11-frontend-architecture.md#11.1.1]
    - [ ] Implement the `authService.ts` API service layer to connect forms to the backend. [Source: architecture/11-frontend-architecture.md#11.1.2]

- [ ] **Task 7: Frontend - Routing and Protection (AC: 5, 8)**
    - [ ] Implement protected routing using Next.js Middleware to secure the `/dashboard`. [Source: architecture/11-frontend-architecture.md#11.1.3]
    - [ ] Implement logic to redirect authenticated users from login/register to the dashboard.

- [x] **Task 8: Testing (AC: All)** *(éƒ¨åˆ†å®Œæˆ)*
    - [ ] Write unit tests with Vitest for the `RegisterForm` and `LoginForm` components to test validation logic. [Source: architecture/17-testing-strategy.md]
    - [x] Write unit tests with Vitest for the `/api/auth/register` backend logic (mocking D1).
    - [ ] Write E2E tests with Playwright for the full registration and login flow.

## Dev Notes
This story establishes the foundational structure of the entire application. All code must strictly adhere to the patterns and locations defined in the architecture documents.

- **UI/UX Design**:
  - All frontend UI development **must** strictly follow the design system, component specifications, and interaction patterns defined in the **`docs/front-end-spec.md`** document.

- **Data Models**:
  - The `User` model is central. It must be defined in `packages/shared/types/user.ts` as specified. [Source: architecture/04-data-models.md]
  
- **API Specifications**:
  - Implement `POST /api/auth/register` and `POST /api/auth/login` exactly as defined in the OpenAPI spec. Pay close attention to request bodies and response codes (201, 400, 409). [Source: architecture/05-api-specification.md]
  - Password hashing **must** occur on the backend. [Source: architecture/16-security-and-performance.md]

- **File Locations**:
  - All frontend code (pages, components, stores, services) goes into `apps/web/`.
  - All backend API routes go into `apps/api/`.
  - Shared types go into `packages/shared/`.
  - Follow the `middleware.ts` pattern for protected routes. [Source: architecture/11-frontend-architecture.md]
  - Follow the Zustand store and service layer patterns for frontend logic. [Source: architecture/11-frontend-architecture.md]

- **Technical Constraints**:
  - Use `pnpm` for package management.
  - Use `Auth.js (NextAuth) v5.0` for authentication.
  - Use `Vitest` for unit tests and `Playwright` for E2E tests.
  - All database queries to D1 must use prepared statements to prevent SQL injection. [Source: architecture/10-data-and-storage-access-patterns.md]

### Testing
- **Unit Tests**: Use Vitest. Test files should be co-located with the source files (e.g., `RegisterForm.test.tsx`). [Source: architecture/17-testing-strategy.md]
- **E2E Tests**: Use Playwright. Tests should reside in a top-level `e2e/` directory. The first test file should be `e2e/auth.spec.ts`. [Source: architecture/17-testing-strategy.md]
- Test for both successful paths (happy paths) and failure cases (e.g., invalid email, existing user, wrong password).

## Change Log

| Date         | Version | Description              | Author       |
|:-------------|:--------|:-------------------------|:-------------|
| 2025å¹´8æœˆ2æ—¥ | 1.0     | Initial draft created.   | Bob, Scrum Master |

## Dev Agent Record
### Agent Model Used
Claude 4 Sonnet (Trae AI)

### Debug Log References
- TypeScript é”™è¯¯ä¿®å¤ï¼š`beforeEach` å¯¼å…¥ç¼ºå¤±ï¼Œ`data` ç±»å‹æ³¨è§£ç¼ºå¤±
- D1 æ•°æ®åº“æ¨¡æ‹Ÿå®ç°ï¼šMockD1Database ç±»åˆ›å»º
- API çŠ¶æ€ç ä¿®æ­£ï¼šæ³¨å†Œ 201ï¼Œç™»å½• 200ï¼Œæ— æ•ˆå‡­æ® 401ï¼Œæ— æ•ˆè¾“å…¥ 400
- æµ‹è¯•ç¯å¢ƒé…ç½®ï¼šVitest + TypeScript ç±»å‹æ£€æŸ¥é›†æˆ

### Completion Notes List
#### âœ… å·²å®Œæˆçš„ä»»åŠ¡ï¼š

**Task 2: Backend - Database and User Model Setup**
- âœ… åˆ›å»ºäº† D1 æ•°æ®åº“ schemaï¼ˆ`packages/shared/schema.sql`ï¼‰
- âœ… å®šä¹‰äº† User æ¥å£ç±»å‹ï¼ˆ`packages/shared/types/user.ts`ï¼‰

**Task 3: Backend - Implement Registration API Endpoint**
- âœ… å®ç°äº† `POST /api/auth/register` API è·¯ç”±
- âœ… å®ç°äº†è¾“å…¥éªŒè¯ï¼ˆemail æ ¼å¼ï¼Œå¯†ç é•¿åº¦ï¼‰
- âœ… å®ç°äº†å¯†ç å“ˆå¸Œï¼ˆbcryptjsï¼‰
- âœ… å®ç°äº†é‡å¤ç”¨æˆ·æ£€æŸ¥é€»è¾‘
- âœ… å®ç°äº†ç”¨æˆ·æ•°æ®æ’å…¥ D1 æ•°æ®åº“

**Task 4: Backend - Implement Authentication and Session Management**
- âœ… å®ç°äº† `POST /api/auth/login` ç«¯ç‚¹
- âœ… å®ç°äº†å¯†ç éªŒè¯é€»è¾‘
- âœ… æ·»åŠ äº†å¥åº·æ£€æŸ¥ç«¯ç‚¹ `GET /health`

**Task 8: Testing**
- âœ… åˆ›å»ºäº†å®Œæ•´çš„ API æµ‹è¯•å¥—ä»¶ï¼ˆ`apps/api/src/index.test.ts`ï¼‰
- âœ… å®ç°äº† D1 æ•°æ®åº“æ¨¡æ‹Ÿï¼ˆMockD1Databaseï¼‰
- âœ… æµ‹è¯•è¦†ç›–ï¼šå¥åº·æ£€æŸ¥ã€ç”¨æˆ·æ³¨å†Œã€ç”¨æˆ·ç™»å½•
- âœ… é…ç½®äº† Vitest + TypeScript ç±»å‹æ£€æŸ¥
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ6/6ï¼‰

#### ğŸ”§ æŠ€æœ¯æ”¹è¿›ï¼š
- âœ… æ·»åŠ äº†è‡ªåŠ¨ TypeScript ç±»å‹æ£€æŸ¥è„šæœ¬
- âœ… é…ç½®äº† Vitest ç±»å‹æ£€æŸ¥é›†æˆ
- âœ… æ¸…ç†äº†ä¸å¿…è¦çš„æœ¬åœ°æ•°æ®åº“æ–‡ä»¶

#### â³ å¾…å®Œæˆçš„ä»»åŠ¡ï¼š
- [ ] Task 1: Monorepo ç»“æ„å®Œå–„
- [ ] Task 5: Frontend UI ç»„ä»¶åˆ›å»º
- [ ] Task 6: Frontend é¡µé¢å’ŒçŠ¶æ€ç®¡ç†
- [ ] Task 7: è·¯ç”±ä¿æŠ¤
- [ ] E2E æµ‹è¯•å®ç°

### File List
#### æ–°åˆ›å»ºçš„æ–‡ä»¶ï¼š
- `apps/api/src/index.ts` - Hono API åº”ç”¨ä¸»æ–‡ä»¶
- `apps/api/src/index.test.ts` - API æµ‹è¯•å¥—ä»¶
- `apps/api/vitest.config.ts` - Vitest é…ç½®
- `apps/api/package.json` - API åŒ…é…ç½®ï¼ˆæ›´æ–°ï¼‰
- `packages/shared/schema.sql` - D1 æ•°æ®åº“ schema
- `packages/shared/types/user.ts` - ç”¨æˆ·ç±»å‹å®šä¹‰

#### ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- `apps/api/package.json` - æ·»åŠ äº†ç±»å‹æ£€æŸ¥è„šæœ¬
- `apps/api/vitest.config.ts` - å¯ç”¨äº†ç±»å‹æ£€æŸ¥

#### åˆ é™¤çš„æ–‡ä»¶ï¼š
- `apps/api/src/lib/database.local.ts` - æ¸…ç†ä¸éœ€è¦çš„æœ¬åœ°æ•°æ®åº“æ–‡ä»¶

## QA Results
N/A
