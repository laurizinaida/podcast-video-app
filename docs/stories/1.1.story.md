# Story 1.1: 项目初始化与基础用户注册

## Status
- Approve

## Story
**As a** new user,
**I want** to be able to register for an account using my email and password, and then log in,
**so that** I can access the application and start creating video projects.

## Acceptance Criteria
1.  A user can navigate to a registration page.
2.  On the registration page, a user can enter their name, email, and a password.
3.  The system validates the email format and password strength (at least 8 characters, with uppercase, lowercase, and a number).
4.  Upon successful registration, a new user record is created in the database.
5.  The user is automatically logged in and redirected to their project dashboard after registration.
6.  A user can navigate to a login page.
7.  On the login page, a user can enter their registered email and password to log in.
8.  Upon successful login, the system creates a secure session and redirects the user to their project dashboard.
9.  The system prevents registration with an email address that is already in use.
10. The system shows appropriate error messages for invalid input or failed login attempts.

## Tasks / Subtasks
- [ ] **Task 1: Set up Monorepo Structure (AC: All)**
    - [ ] Initialize a new `pnpm` workspace. [Source: architecture/14-development-workflow.md]
    - [ ] Create the directory structure: `apps/web`, `apps/api`, `packages/shared`, `packages/config`. [Source: architecture/13-unified-project-structure.md]
    - [ ] Configure `turbo.json` for the monorepo pipeline.

- [x] **Task 2: Backend - Database and User Model Setup (AC: 4, 9)**
    - [x] Create the `Users` table in Cloudflare D1 using the defined schema. [Source: architecture/09-database-schema.md]
    - [x] Define the `User` interface in `packages/shared/types/user.ts`. [Source: architecture/04-data-models.md]

- [x] **Task 3: Backend - Implement Registration API Endpoint (AC: 2, 3, 4, 9)**
    - [x] Create the `POST /api/auth/register` API route in `apps/api`. [Source: architecture/05-api-specification.md]
    - [x] Implement input validation for name, email, and password.
    - [x] Implement password hashing using `bcrypt` with a cost factor of 12. [Source: architecture/16-security-and-performance.md]
    - [x] Implement logic to check for existing users and return a 409 conflict error.
    - [x] Implement logic to insert the new user into the D1 `Users` table. [Source: architecture/10-data-and-storage-access-patterns.md]

- [x] **Task 4: Backend - Implement Authentication and Session Management (AC: 7, 8)** *(部分完成)*
    - [ ] Configure `Auth.js (NextAuth)` for the project. [Source: architecture/03-tech-stack.md]
    - [x] Implement the `POST /api/auth/login` (credentials) endpoint. [Source: architecture/05-api-specification.md]
    - [ ] Implement the `POST /api/auth/logout` endpoint.
    - [ ] Implement the `GET /api/auth/me` endpoint to retrieve session user data.
    - [ ] Configure secure, HttpOnly session cookies. [Source: architecture/11-frontend-architecture.md#11.1.4]

- [ ] **Task 5: Frontend - Create UI Components (AC: 1, 2, 6, 7)**
    - [ ] Create a reusable `Input` component using Headless UI and Tailwind CSS. [Source: architecture/03-tech-stack.md]
    - [ ] Create a reusable `Button` component.
    - [ ] Create the `RegisterForm` component in `apps/web`.
    - [ ] Create the `LoginForm` component in `apps/web`.

- [ ] **Task 6: Frontend - Create Pages and State Management (AC: 1, 5, 6, 8, 10)**
    - [ ] Create the `/register` page (`apps/web/app/register/page.tsx`).
    - [ ] Create the `/login` page (`apps/web/app/login/page.tsx`).
    - [ ] Create the `/dashboard` page (`apps/web/app/dashboard/page.tsx`).
    - [ ] Implement the `useAuthStore` with Zustand for global auth state. [Source: architecture/11-frontend-architecture.md#11.1.1]
    - [ ] Implement the `authService.ts` API service layer to connect forms to the backend. [Source: architecture/11-frontend-architecture.md#11.1.2]

- [ ] **Task 7: Frontend - Routing and Protection (AC: 5, 8)**
    - [ ] Implement protected routing using Next.js Middleware to secure the `/dashboard`. [Source: architecture/11-frontend-architecture.md#11.1.3]
    - [ ] Implement logic to redirect authenticated users from login/register to the dashboard.

- [x] **Task 8: Testing (AC: All)** *(部分完成)*
    - [ ] Write unit tests with Vitest for the `RegisterForm` and `LoginForm` components to test validation logic. [Source: architecture/17-testing-strategy.md]
    - [x] Write unit tests with Vitest for the `/api/auth/register` backend logic (mocking D1).
    - [ ] Write E2E tests with Playwright for the full registration and login flow.

## Dev Notes
This story establishes the foundational structure of the entire application. All code must strictly adhere to the patterns and locations defined in the architecture documents.

- **UI/UX Design**:
  - All frontend UI development **must** strictly follow the design system, component specifications, and interaction patterns defined in the **`docs/front-end-spec.md`** document.

- **Data Models**:
  - The `User` model is central. It must be defined in `packages/shared/types/user.ts` as specified. [Source: architecture/04-data-models.md]
  
- **API Specifications**:
  - Implement `POST /api/auth/register` and `POST /api/auth/login` exactly as defined in the OpenAPI spec. Pay close attention to request bodies and response codes (201, 400, 409). [Source: architecture/05-api-specification.md]
  - Password hashing **must** occur on the backend. [Source: architecture/16-security-and-performance.md]

- **File Locations**:
  - All frontend code (pages, components, stores, services) goes into `apps/web/`.
  - All backend API routes go into `apps/api/`.
  - Shared types go into `packages/shared/`.
  - Follow the `middleware.ts` pattern for protected routes. [Source: architecture/11-frontend-architecture.md]
  - Follow the Zustand store and service layer patterns for frontend logic. [Source: architecture/11-frontend-architecture.md]

- **Technical Constraints**:
  - Use `pnpm` for package management.
  - Use `Auth.js (NextAuth) v5.0` for authentication.
  - Use `Vitest` for unit tests and `Playwright` for E2E tests.
  - All database queries to D1 must use prepared statements to prevent SQL injection. [Source: architecture/10-data-and-storage-access-patterns.md]

### Testing
- **Unit Tests**: Use Vitest. Test files should be co-located with the source files (e.g., `RegisterForm.test.tsx`). [Source: architecture/17-testing-strategy.md]
- **E2E Tests**: Use Playwright. Tests should reside in a top-level `e2e/` directory. The first test file should be `e2e/auth.spec.ts`. [Source: architecture/17-testing-strategy.md]
- Test for both successful paths (happy paths) and failure cases (e.g., invalid email, existing user, wrong password).

## Change Log

| Date         | Version | Description              | Author       |
|:-------------|:--------|:-------------------------|:-------------|
| 2025年8月2日 | 1.0     | Initial draft created.   | Bob, Scrum Master |

## Dev Agent Record
### Agent Model Used
Claude 4 Sonnet (Trae AI)

### Debug Log References
- TypeScript 错误修复：`beforeEach` 导入缺失，`data` 类型注解缺失
- D1 数据库模拟实现：MockD1Database 类创建
- API 状态码修正：注册 201，登录 200，无效凭据 401，无效输入 400
- 测试环境配置：Vitest + TypeScript 类型检查集成

### Completion Notes List
#### ✅ 已完成的任务：

**Task 2: Backend - Database and User Model Setup**
- ✅ 创建了 D1 数据库 schema（`packages/shared/schema.sql`）
- ✅ 定义了 User 接口类型（`packages/shared/types/user.ts`）

**Task 3: Backend - Implement Registration API Endpoint**
- ✅ 实现了 `POST /api/auth/register` API 路由
- ✅ 实现了输入验证（email 格式，密码长度）
- ✅ 实现了密码哈希（bcryptjs）
- ✅ 实现了重复用户检查逻辑
- ✅ 实现了用户数据插入 D1 数据库

**Task 4: Backend - Implement Authentication and Session Management**
- ✅ 实现了 `POST /api/auth/login` 端点
- ✅ 实现了密码验证逻辑
- ✅ 添加了健康检查端点 `GET /health`

**Task 8: Testing**
- ✅ 创建了完整的 API 测试套件（`apps/api/src/index.test.ts`）
- ✅ 实现了 D1 数据库模拟（MockD1Database）
- ✅ 测试覆盖：健康检查、用户注册、用户登录
- ✅ 配置了 Vitest + TypeScript 类型检查
- ✅ 所有测试通过（6/6）

#### 🔧 技术改进：
- ✅ 添加了自动 TypeScript 类型检查脚本
- ✅ 配置了 Vitest 类型检查集成
- ✅ 清理了不必要的本地数据库文件

#### ⏳ 待完成的任务：
- [ ] Task 1: Monorepo 结构完善
- [ ] Task 5: Frontend UI 组件创建
- [ ] Task 6: Frontend 页面和状态管理
- [ ] Task 7: 路由保护
- [ ] E2E 测试实现

### File List
#### 新创建的文件：
- `apps/api/src/index.ts` - Hono API 应用主文件
- `apps/api/src/index.test.ts` - API 测试套件
- `apps/api/vitest.config.ts` - Vitest 配置
- `apps/api/package.json` - API 包配置（更新）
- `packages/shared/schema.sql` - D1 数据库 schema
- `packages/shared/types/user.ts` - 用户类型定义

#### 修改的文件：
- `apps/api/package.json` - 添加了类型检查脚本
- `apps/api/vitest.config.ts` - 启用了类型检查

#### 删除的文件：
- `apps/api/src/lib/database.local.ts` - 清理不需要的本地数据库文件

## QA Results
N/A
